(function(){var __bind=function(fn,me){return function(){return fn.apply(me,arguments)}};window.app={user:null,init:function(){if(browser.isSupported()){this.bindEvents();return this.loadSession()}return browser.showIncompatibleMessage()},loadSession:function(){return SS.server.app.init(__bind(function(user){return user?this.signUserIn(user):this.displaySignInForm()},this))},signUserIn:function(user){this.setUser(user);return $("#main").show()},setUser:function(data){app.user=data,this.currentScrollPosition["#messages"]=$("#messages")[0].scrollHeight,this.scrollingHelper("#messages",450),this.scrollingHelper("#people",350);return SS.server.app.getUsersOnline(app.appendUsersToPeopleList)},displaySignInForm:function(){return $("#signIn").show().submit(__bind(function(){SS.server.app.signIn($("#signIn").find("input").val(),__bind(function(response){$("#signInError").remove();if(response===!1){$("#signIn").find("input").val("");return $("#signIn").append("<p id='signInError'>The CDID you provided was incorrect. Sorry.</p>")}$("#signIn").fadeOut(230);return this.signUserIn(response)},this));return!1},this))},calculatecurrentScrollPositionForPeopleList:function(){if(this.disableScrolling["#people"]==null){$("#people").animate({scrollTop:$("#people")[0].scrollHeight},{duration:"slow",easing:"swing",queue:!1});return app.currentScrollPosition["#people"]=$("#people")[0].scrollHeight-350}},updatePeopleCount:function(){var count,text;count=this.Person.online().count(),text=count===1?"1 person online":""+count+" people online";return $("#peepsOnline").text(text)},appendUsersToPeopleList:function(people){var person,_i,_len,_results;_results=[];for(_i=0,_len=people.length;_i<_len;_i++)person=people[_i],_results.push(app.Person.find(person.id)==null?(new app.Person(person)).save():void 0);return _results},scrollingHelper:function(divId,adjustmentLevel){return $(divId).mousewheel(function(event,delta,deltaX,deltaY){app.disableScrolling[divId]=!0;if(!(delta>0))return app.currentScrollPosition[divId]>=$(divId)[0].scrollHeight-adjustmentLevel?app.disableScrolling[divId]=null:$(divId).scrollTop(app.currentScrollPosition[divId]+=20*Math.abs(delta));if(!(app.currentScrollPosition[divId]<=0))return $(divId).scrollTop(app.currentScrollPosition[divId]-=20*Math.abs(delta))})},bindEvents:function(){this.disableScrolling={},this.currentScrollPosition={},this.messageTemplate=new SmartTemplate("message",{bindDataToCssClasses:!0,afterAdd:function(object){return object.fadeIn(50)}}),this.personTemplate=new SmartTemplate("person",{bindDataToCssClasses:!0,afterAdd:function(object){return object.fadeIn(50)}}),this.Person=new Model("person",function(){this.unique_key="cdid",this.include({signIn:function(){this.attributes.online=!0,this.attributes.id=this.attributes.cdid,$("#person_"+this.attributes.id).length===0&&app.personTemplate.add(this.attributes),app.updatePeopleCount();return app.calculatecurrentScrollPositionForPeopleList()},signOut:function(){this.attributes.online=!1,app.personTemplate.remove(this.attributes.cdid),app.updatePeopleCount();return app.calculatecurrentScrollPositionForPeopleList()}});return this.extend({online:function(){return this.select(function(){return this.attr("online")===!0})}})}),this.Person.bind("add",function(newObject){return newObject.signIn()}),$("img.avatar").live("click",function(){var cdid;this.userInfoTemplate=new SmartTemplate("userInfo",{bindDataToCssClasses:!0,afterAdd:function(object){object.fadeIn(250);return object.click(function(){return $(this).fadeOut()})},appendTo:$(this).parent(),cssStyleProperties:{position:"absolute",top:$(this).offset().top-10,left:$(this).offset().left-10}}),cdid=$(this).attr("src").split("/")[7];return this.userInfoTemplate.add(app.Person.find(cdid).attributes)}),$("form#sendMessage").submit(function(){var newMessage;newMessage=$("#newMessage").val(),newMessage!==""&&SS.server.app.sendMessage(newMessage,function(data){return $("#newMessage").val("")});return!1}),$("#getCodeLink").click(function(){$("#getCode").fadeIn();return $("#getCode").click(function(){return $(this).fadeOut()})}),SS.events.on("newMessage",__bind(function(params){this.messageTemplate.add(params);if(this.disableScrolling["#messages"]==null){$("#messages").animate({scrollTop:$("#messages")[0].scrollHeight},{duration:"slow",easing:"swing",queue:!1});return this.currentScrollPosition["#messages"]=$("#messages")[0].scrollHeight-450}},this)),SS.events.on("signedIn",__bind(function(params){if(app.user.cdid!==params.cdid)return this.Person.find(params.cdid)!=null?this.Person.find(params.cdid).signIn():(new this.Person(params)).save()},this));return SS.events.on("signedOut",function(params){try{return app.Person.find(params).signOut()}catch(e){return console.error(e)}})}}}).call(this),function(){window.browser={isSupported:function(){return $.browser.safari===!0||$.browser.webkit===!0||$.browser.mozilla===!0&&parseInt($.browser.version)===2},showIncompatibleMessage:function(){$(".views").hide(),$("#browserNotSupported").show();return $.browser.msie===!0?$("#loveLetterToIE").show():$("#sorryFirefoxOperaPeeps").show()}}}.call(this)